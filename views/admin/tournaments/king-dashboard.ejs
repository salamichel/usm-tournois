<h1 class="text-3xl font-bold mb-6">ğŸ† Tournoi King: <%= tournament.name %></h1>
<div id="tournament-data" data-tournament-id="<%= tournament.id %>" data-current-king-phase="<%= tournament.currentKingPhase || 0 %>" data-is-king-phase-completed="<%= tournament.isKingPhaseCompleted ? 'true' : 'false' %>" style="display: none;"></div>

<div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
    <div class="lg:col-span-1 space-y-4 max-h-screen overflow-y-auto">
        <div class="glass-card p-4 rounded-lg bg-gray-900/50 border border-gray-700">
            <h3 class="text-sm font-bold text-gray-300 mb-3 uppercase">ğŸ“Š Stats</h3>
            <div class="space-y-2 text-xs">
                <div class="flex justify-between"><span class="text-gray-400">Phase</span><span class="text-blue-400 font-bold"><% if (tournament.currentKingPhase === 0) { %>Attente<% } else if (tournament.currentKingPhase === 1) { %>Phase 1<% } else if (tournament.currentKingPhase === 2) { %>Phase 2<% } else { %>Finale<% } %></span></div>
                <div class="flex justify-between"><span class="text-gray-400">Joueurs</span><span class="text-purple-400 font-bold"><%= players.length %></span></div>
                <div class="flex justify-between"><span class="text-gray-400">Statut</span><span class="<%= tournament.isKingPhaseCompleted ? 'text-green-400' : tournament.currentKingPhase > 0 ? 'text-orange-400' : 'text-gray-500' %> font-bold"><% if (tournament.isKingPhaseCompleted) { %>âœ“ Ok<% } else if (tournament.currentKingPhase > 0) { %>â³ Cours<% } else { %>â¸ Attente<% } %></span></div>
            </div>
        </div>

        <div class="glass-card p-4 rounded-lg bg-gray-900/50 border border-gray-700">
            <h3 class="text-sm font-bold text-gray-300 mb-3 uppercase">âš¡ Actions</h3>
            <div class="space-y-2">
                <% if (tournament.currentKingPhase === 0) { %><button id="startPhase1Btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded text-xs">ğŸš€ Phase 1</button><% } %>
                <% if (tournament.currentKingPhase >= 1) { %><button id="setAllMatchesScoresBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded text-xs">ğŸ² Scores AlÃ©a.</button><% } %>
                <% if (tournament.currentKingPhase >= 1 && tournament.isKingPhaseCompleted) { %><button id="startPhase2Btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded text-xs">â¡ï¸ Phase 2</button><% } %>
                <% if (tournament.currentKingPhase >= 2 && tournament.isKingPhaseCompleted) { %><button id="startPhase3Btn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-3 rounded text-xs">ğŸ‘‘ Finale</button><% } %>
                <div class="border-t border-gray-600 mt-2 pt-2 space-y-2">
                    <% if (tournament.currentKingPhase >= 1) { %><button id="resetPhase1Btn" class="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-1 px-2 rounded text-xs border border-red-600">ğŸ”„ Reset P1</button><% } %>
                    <% if (tournament.currentKingPhase >= 2) { %><button id="resetPhase2Btn" class="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-1 px-2 rounded text-xs border border-red-600">ğŸ”„ Reset P2</button><% } %>
                    <% if (tournament.currentKingPhase >= 3) { %><button id="resetPhase3Btn" class="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-1 px-2 rounded text-xs border border-red-600">ğŸ”„ Reset Fin.</button><% } %>
                </div>
            </div>
        </div>       

        <div class="glass-card p-4 rounded-lg bg-gray-900/50 border border-gray-700">
            <h3 class="text-sm font-bold text-gray-300 mb-3 uppercase">ğŸ‘‘ Top 8</h3>
            <div class="space-y-2 text-xs max-h-48 overflow-y-auto">
                <% if (kingData.ranking && kingData.ranking.length > 0) { %>
                    <% kingData.ranking.slice(0, 8).forEach((p, i) => { %>
                        <div class="bg-gray-800 p-2 rounded border-l-2 <%= i === 0 ? 'border-yellow-500' : 'border-blue-500' %>">
                            <p class="text-gray-200 font-semibold <%= i === 0 ? 'text-yellow-400' : '' %>"><%= i === 0 ? 'ğŸ‘‘ '+ (p.pseudo || p.name): (++i + '. ' + (p.pseudo || p.name)) %></p>
                            <p class="text-gray-400 text-xs">V: <%= p.wins || 0 %> | S+: <%= p.setsWon || 0 %> | S-: <%= p.setsLost || 0 %> | <%= (p.winPercentage || 0).toFixed(1) %>%</p>
                        </div>
                    <% }); %>
                <% } else { %>
                    <p class="text-gray-500 italic">Classement vide</p>
                <% } %>
            </div>
        </div>
    </div>

    <div class="lg:col-span-3">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-2 mb-6 border-b border-gray-700 flex-wrap">
            <% if (tournament.currentKingPhase >= 1) { %><button class="tab-btn active" data-tab="phase1" style="padding: 12px 20px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgb(59, 130, 246); border-bottom: 2px solid rgb(59, 130, 246); color: white; font-bold; cursor: pointer; border-radius: 4px 4px 0 0;">ğŸ“Š Phase 1: 4v4</button><% } %>
            <% if (tournament.currentKingPhase >= 2) { %><button class="tab-btn" data-tab="phase2" style="padding: 12px 20px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgb(75, 85, 99); color: white; font-bold; cursor: pointer; border-radius: 4px 4px 0 0;">ğŸ“Š Phase 2: 3v3</button><% } %>
            <% if (tournament.currentKingPhase >= 3) { %><button class="tab-btn" data-tab="phase3" style="padding: 12px 20px; background: rgba(55, 65, 81, 0.5); border: 1px solid rgb(75, 85, 99); color: white; font-bold; cursor: pointer; border-radius: 4px 4px 0 0;">ğŸ‘‘ Phase 3: 2v2</button><% } %>
        </div>

        <% if (tournament.currentKingPhase >= 1 && kingData && kingData.phases.find(p => p.phaseNumber === 1)) { %>
            <% const phase1 = kingData.phases.find(p => p.phaseNumber === 1); const phase1Players = Array.from(new Map([...phase1.pools.flatMap(p => p.rounds || []).flatMap(r => r.matches || []).flatMap(m => [...(m.team1?.members || []), ...(m.team2?.members || [])])].map(p => [p.id, p])).values()); %>
            <div id="phase1" class="tab-content space-y-4">
                <div class="glass-card p-4 rounded-lg bg-gray-900/50 border border-gray-700">
                    <div class="grid grid-cols-4 md:grid-cols-4 gap-4">
                        <div><p class="text-gray-400 text-sm">Poules</p><p class="text-2xl font-bold text-blue-400"><%= phase1.pools.length %></p></div>
                        <div><p class="text-gray-400 text-sm">Joueurs</p><p class="text-2xl font-bold text-purple-400"><%= phase1Players.length %></p></div>
                        <% let mc1 = 0; phase1.pools.forEach(p => { (p.rounds || []).forEach(r => { mc1 += (r.matches || []).length; }); }); %>
                        <div><p class="text-gray-400 text-sm">Matchs</p><p class="text-2xl font-bold text-yellow-400"><%= mc1 %></p></div>
                        <div><p class="text-gray-400 text-sm">Format</p><p class="text-2xl font-bold text-green-400">4v4</p></div>
                    </div>
                </div>

                <% if (phase1.ranking && phase1.ranking.length > 0) { %>
                    <div class="glass-card p-4 rounded-lg bg-gray-900/50 border border-gray-700">
                        <h3 class="text-sm font-bold text-gray-300 mb-3 uppercase">ğŸ… Classement Phase 1</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-xs">
                            <% phase1.ranking.forEach((p, i) => { %>
                                <div class="bg-gray-800 p-2 rounded border-l-2 border-blue-500">
                                    <p class="text-gray-200 font-semibold"><%= i+1 %>. <%= p.pseudo || p.name %> <span class="text-gray-500">(<%= p.wins || 0 %>V | <%= (p.winPercentage || 0).toFixed(1) %>%)</span></p>
                                    <p class="text-gray-400 text-xs">Sets: <%= p.setsWon || 0 %> / <%= p.setsLost || 0 %></p>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                <% } %>

                <% phase1.pools.forEach(pool => { %>
                    <div class="glass-card rounded-lg overflow-hidden border border-gray-700 mb-4">
                        <div class="bg-gradient-to-r from-blue-900 to-blue-700 p-4 cursor-pointer phase-header" data-target="pool<%= pool.id %>">
                            <div class="flex justify-between items-center"><h3 class="text-lg font-bold text-white">ğŸ“ <%= pool.name %> (<%= pool.players ? pool.players.length : 0 %> j.)</h3><span class="text-2xl toggle-icon">â–¼</span></div>
                        </div>
                        <div id="pool<%= pool.id %>" class="phase-content p-4 space-y-4">
                            <% const poolTeams = kingData.currentPhaseTeams?.filter(t => t.poolId === pool.id) || []; const poolPlayers = Array.from(new Map(poolTeams.flatMap(t => [...(t.team1?.members || []), ...(t.team2?.members || [])]).map(p => [p.id, p])).values()); %>
                            <div class="glass-card p-3 rounded-lg bg-gray-800 border border-gray-600">
                                <h4 class="text-sm font-bold text-gray-300 mb-2 uppercase">ğŸ‘¥ Joueurs Poule</h4>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-xs">
                                    <% pool.players.forEach((p, i) => { %><div class="bg-gray-700 p-1 rounded border-l-2 border-blue-500"><p class="text-gray-200 text-center truncate"><%= i+1 %>. <%= p.pseudo || p.name %></p></div><% }); %>
                                </div>
                            </div>
                            <% (pool.rounds || []).forEach((round, rIdx) => { %>
                                <div class="bg-gray-800 border-l-4 border-yellow-500 rounded p-3 cursor-pointer" data-target="round<%= round.id %>">
                                    <div class="flex justify-between items-center"><div><h4 class="font-bold text-yellow-300">ğŸ”„ TournÃ©e <%= rIdx + 1 %></h4><p class="text-gray-400 text-xs"><%= round.matches ? round.matches.length : 0 %> match(s)</p></div><span class="text-xl toggle-icon">â–¼</span></div>
                                </div>
                                <div id="round<%= round.id %>" class="phase-content space-y-3">
                                    <% (round.matches || []).forEach((match, mIdx) => { %>
                                        <div class="bg-gray-800 rounded border match-card <%= match.status === 'completed' ? 'border-green-600' : 'border-gray-600' %>">
                                            <div class="bg-gray-750 p-2 flex justify-between items-center text-sm"><span class="text-gray-300">M<%= mIdx + 1 %></span><span class="match-status <%= match.status === 'completed' ? 'text-green-400' : 'text-orange-400' %> text-xs font-bold"><%= match.status === 'completed' ? 'âœ“' : 'â³' %></span></div>
                                            <div class="p-3">
                                                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center mb-3">
                                                    <div class="bg-gray-900 rounded p-2 border-l-4 border-blue-500 text-xs"><p class="text-blue-300 font-bold text-center mb-1"><%= match.team1 ? match.team1.name : 'Ã‰quipe 1' %></p><% (match.team1?.members || []).forEach(m => { %><p class="text-gray-300 truncate">â€¢ <%= m.pseudo || m.name %></p><% }); %></div>
                                                    <div class="bg-gradient-to-b from-gray-750 to-gray-900 rounded p-2 text-center border border-gray-600"><% if (match.status === 'completed') { %><div class="text-2xl font-bold"><span class="text-blue-400"><%= match.setsWonTeam1 || 0 %></span><span class="text-gray-400">-</span><span class="text-red-400"><%= match.setsWonTeam2 || 0 %></span></div><% } else { %><p class="text-gray-500 text-xs">â€”</p><% } %></div>
                                                    <div class="bg-gray-900 rounded p-2 border-l-4 border-red-500 text-xs"><p class="text-red-300 font-bold text-center mb-1"><%= match.team2 ? match.team2.name : 'Ã‰quipe 2' %></p><% (match.team2?.members || []).forEach(m => { %><p class="text-gray-300 truncate">â€¢ <%= m.pseudo || m.name %></p><% }); %></div>
                                                </div>
                                                <form class="record-score-form" data-tournament-id="<%= tournament.id %>" data-match-id="<%= match.id %>" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 4px; align-items: end;">
                                                    <input type="number" name="setsWonTeam1" value="<%= match.setsWonTeam1 || 0 %>" min="0" class="p-1 text-xs rounded bg-gray-700 text-white text-center border border-gray-600" required>
                                                    <input type="number" name="setsWonTeam2" value="<%= match.setsWonTeam2 || 0 %>" min="0" class="p-1 text-xs rounded bg-gray-700 text-white text-center border border-gray-600" required>
                                                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold rounded px-2 py-1 text-xs">âœï¸</button>
                                                </form>
                                            </div>
                                        </div>
                                    <% }); %>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                <% }); %>
            </div>
        <% } %>

        <% if (tournament.currentKingPhase >= 2 && kingData && kingData.phases.find(p => p.phaseNumber === 2)) { %>
            <% const phase2 = kingData.phases.find(p => p.phaseNumber === 2); %>
            <div id="phase2" class="tab-content space-y-4 hidden">
                <div class="glass-card p-4 rounded-lg bg-gray-900/50 border border-gray-700">
                    <div class="grid grid-cols-4 md:grid-cols-4 gap-4">
                        <div><p class="text-gray-400 text-sm">Poules</p><p class="text-2xl font-bold text-green-400"><%= phase2.pools.length %></p></div>
                        <% const p2players = Array.from(new Map([...phase2.pools.flatMap(p => p.rounds || []).flatMap(r => r.matches || []).flatMap(m => [...(m.team1?.members || []), ...(m.team2?.members || [])])].map(p => [p.id, p])).values()); %>
                        <div><p class="text-gray-400 text-sm">Joueurs</p><p class="text-2xl font-bold text-purple-400"><%= p2players.length %></p></div>
                        <% let mc2 = 0; phase2.pools.forEach(p => { (p.rounds || []).forEach(r => { mc2 += (r.matches || []).length; }); }); %>
                        <div><p class="text-gray-400 text-sm">Matchs</p><p class="text-2xl font-bold text-yellow-400"><%= mc2 %></p></div>
                        <div><p class="text-gray-400 text-sm">Format</p><p class="text-2xl font-bold text-green-400">3v3</p></div>
                    </div>
                </div>

                <% if (phase2.ranking && phase2.ranking.length > 0) { %>
                    <div class="glass-card p-4 rounded-lg bg-gray-900/50 border border-gray-700">
                        <h3 class="text-sm font-bold text-gray-300 mb-3 uppercase">ğŸ… Classement Phase 2</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-xs">
                            <% phase2.ranking.forEach((p, i) => { %>
                                <div class="bg-gray-800 p-2 rounded border-l-2 border-green-500">
                                    <p class="text-gray-200 font-semibold"><%= i+1 %>. <%= p.pseudo || p.name %> <span class="text-gray-500">(<%= p.wins || 0 %>V | <%= (p.winPercentage || 0).toFixed(1) %>%)</span></p>
                                    <p class="text-gray-400 text-xs">Sets: <%= p.setsWon || 0 %> / <%= p.setsLost || 0 %></p>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                <% } %>

                <% phase2.pools.forEach(pool => { %>
                    <div class="glass-card rounded-lg overflow-hidden border border-gray-700 mb-4">
                        <div class="bg-gradient-to-r from-green-900 to-green-700 p-4 cursor-pointer phase-header" data-target="pool<%= pool.id %>">
                            <div class="flex justify-between items-center"><h3 class="text-lg font-bold text-white">ğŸ“ <%= pool.name %> (<%= pool.players ? pool.players.length : 0 %> j.)</h3><span class="text-2xl toggle-icon">â–¼</span></div>
                        </div>
                        <div id="pool<%= pool.id %>" class="phase-content p-4 space-y-4">
                            <% const poolTeams = kingData.currentPhaseTeams?.filter(t => t.poolId === pool.id) || []; const poolPlayers = Array.from(new Map(poolTeams.flatMap(t => [...(t.team1?.members || []), ...(t.team2?.members || [])]).map(p => [p.id, p])).values()); %>
                            <div class="glass-card p-3 rounded-lg bg-gray-800 border border-gray-600">
                                <h4 class="text-sm font-bold text-gray-300 mb-2 uppercase">ğŸ‘¥ Joueurs Poule</h4>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-xs">
                                    <% pool.players.forEach((p, i) => { %><div class="bg-gray-700 p-1 rounded border-l-2 border-green-500"><p class="text-gray-200 text-center truncate"><%= i+1 %>. <%= p.pseudo || p.name %></p></div><% }); %>
                                </div>
                            </div>
                            <% (pool.rounds || []).forEach((round, rIdx) => { %>
                                <div class="bg-gray-800 border-l-4 border-yellow-500 rounded p-3 cursor-pointer" data-target="round<%= round.id %>">
                                    <div class="flex justify-between items-center"><div><h4 class="font-bold text-yellow-300">ğŸ”„ TournÃ©e <%= rIdx + 1 %></h4><p class="text-gray-400 text-xs"><%= round.matches ? round.matches.length : 0 %> match(s)</p></div><span class="text-xl toggle-icon">â–¼</span></div>
                                </div>
                                <div id="round<%= round.id %>" class="phase-content space-y-3">
                                    <% (round.matches || []).forEach((match, mIdx) => { %>
                                        <div class="bg-gray-800 rounded border match-card <%= match.status === 'completed' ? 'border-green-600' : 'border-gray-600' %>">
                                            <div class="bg-gray-750 p-2 flex justify-between items-center text-sm"><span class="text-gray-300">M<%= mIdx + 1 %></span><span class="match-status <%= match.status === 'completed' ? 'text-green-400' : 'text-orange-400' %> text-xs font-bold"><%= match.status === 'completed' ? 'âœ“' : 'â³' %></span></div>
                                            <div class="p-3">
                                                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center mb-3">
                                                    <div class="bg-gray-900 rounded p-2 border-l-4 border-green-500 text-xs"><p class="text-green-300 font-bold text-center mb-1"><%= match.team1 ? match.team1.name : 'Ã‰quipe 1' %></p><% (match.team1?.members || []).forEach(m => { %><p class="text-gray-300 truncate">â€¢ <%= m.pseudo || m.name %></p><% }); %></div>
                                                    <div class="bg-gradient-to-b from-gray-750 to-gray-900 rounded p-2 text-center border border-gray-600"><% if (match.status === 'completed') { %><div class="text-2xl font-bold"><span class="text-green-400"><%= match.setsWonTeam1 || 0 %></span><span class="text-gray-400">-</span><span class="text-red-400"><%= match.setsWonTeam2 || 0 %></span></div><% } else { %><p class="text-gray-500 text-xs">â€”</p><% } %></div>
                                                    <div class="bg-gray-900 rounded p-2 border-l-4 border-red-500 text-xs"><p class="text-red-300 font-bold text-center mb-1"><%= match.team2 ? match.team2.name : 'Ã‰quipe 2' %></p><% (match.team2?.members || []).forEach(m => { %><p class="text-gray-300 truncate">â€¢ <%= m.pseudo || m.name %></p><% }); %></div>
                                                </div>
                                                <form class="record-score-form" data-tournament-id="<%= tournament.id %>" data-match-id="<%= match.id %>" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 4px; align-items: end;">
                                                    <input type="number" name="setsWonTeam1" value="<%= match.setsWonTeam1 || 0 %>" min="0" class="p-1 text-xs rounded bg-gray-700 text-white text-center border border-gray-600" required>
                                                    <input type="number" name="setsWonTeam2" value="<%= match.setsWonTeam2 || 0 %>" min="0" class="p-1 text-xs rounded bg-gray-700 text-white text-center border border-gray-600" required>
                                                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold rounded px-2 py-1 text-xs">âœï¸</button>
                                                </form>
                                            </div>
                                        </div>
                                    <% }); %>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                <% }); %>
            </div>
        <% } %>

        <% if (tournament.currentKingPhase >= 3 && kingData && kingData.phases.find(p => p.phaseNumber === 3)) { %>
            <% const phase3 = kingData.phases.find(p => p.phaseNumber === 3); %>
            <div id="phase3" class="tab-content space-y-4 hidden">
                <div class="glass-card p-4 rounded-lg bg-gray-900/50 border border-gray-700">
                    <div class="grid grid-cols-4 md:grid-cols-4 gap-4">
                        <div><p class="text-gray-400 text-sm">Poules</p><p class="text-2xl font-bold text-purple-400"><%= phase3.pools.length %></p></div>
                        <% const p3players = Array.from(new Map([...phase3.pools.flatMap(p => p.rounds || []).flatMap(r => r.matches || []).flatMap(m => [...(m.team1?.members || []), ...(m.team2?.members || [])])].map(p => [p.id, p])).values()); %>
                        <div><p class="text-gray-400 text-sm">Finalistes</p><p class="text-2xl font-bold text-red-400"><%= p3players.length %></p></div>
                        <% let mc3 = 0; phase3.pools.forEach(p => { (p.rounds || []).forEach(r => { mc3 += (r.matches || []).length; }); }); %>
                        <div><p class="text-gray-400 text-sm">Matchs</p><p class="text-2xl font-bold text-yellow-400"><%= mc3 %></p></div>
                        <div><p class="text-gray-400 text-sm">Format</p><p class="text-2xl font-bold text-red-400">2v2</p></div>
                    </div>
                </div>

                <% if (phase3.ranking && phase3.ranking.length > 0) { %>
                    <div class="glass-card p-4 rounded-lg bg-gray-900/50 border border-gray-700">
                        <h3 class="text-sm font-bold text-gray-300 mb-3 uppercase">ğŸ‘‘ Classement Phase 3</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                            <% phase3.ranking.forEach((p, i) => { %>
                                <div class="bg-gray-800 p-2 rounded border-l-2 border-red-500">
                                    <p class="text-gray-200 font-semibold"><%= i+1 %>. <%= p.pseudo || p.name %> <span class="text-gray-500">(<%= p.wins || 0 %>V | <%= (p.winPercentage || 0).toFixed(1) %>%)</span></p>
                                    <p class="text-gray-400 text-xs">Sets: <%= p.setsWon || 0 %> / <%= p.setsLost || 0 %></p>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                <% } %>

                <% phase3.pools.forEach(pool => { %>
                    <div class="glass-card rounded-lg overflow-hidden border border-gray-700 mb-4">
                        <div class="bg-gradient-to-r from-purple-900 to-purple-700 p-4 cursor-pointer phase-header" data-target="pool<%= pool.id %>">
                            <div class="flex justify-between items-center"><h3 class="text-lg font-bold text-white">ğŸ‘‘ <%= pool.name %> (<%= pool.players ? pool.players.length : 0 %> j.)</h3><span class="text-2xl toggle-icon">â–¼</span></div>
                        </div>
                        <div id="pool<%= pool.id %>" class="phase-content p-4 space-y-4">
                            <% const poolTeams = kingData.currentPhaseTeams?.filter(t => t.poolId === pool.id) || []; const poolPlayers = Array.from(new Map(poolTeams.flatMap(t => [...(t.team1?.members || []), ...(t.team2?.members || [])]).map(p => [p.id, p])).values()); %>
                            <div class="glass-card p-3 rounded-lg bg-gray-800 border border-gray-600">
                                <h4 class="text-sm font-bold text-gray-300 mb-2 uppercase">ğŸ‘‘ Finalistes Poule</h4>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-xs">
                                    <% poolPlayers.forEach((p, i) => { %><div class="bg-gray-700 p-1 rounded border-l-2 border-red-500"><p class="text-gray-200 text-center truncate"><%= i+1 %>. <%= p.pseudo || p.name %></p></div><% }); %>
                                </div>
                            </div>
                            <% (pool.rounds || []).forEach((round, rIdx) => { %>
                                <div class="bg-gray-800 border-l-4 border-yellow-500 rounded p-3 cursor-pointer" data-target="round<%= round.id %>">
                                    <div class="flex justify-between items-center"><div><h4 class="font-bold text-yellow-300">ğŸ”„ TournÃ©e <%= rIdx + 1 %></h4><p class="text-gray-400 text-xs"><%= round.matches ? round.matches.length : 0 %> match(s)</p></div><span class="text-xl toggle-icon">â–¼</span></div>
                                </div>
                                <div id="round<%= round.id %>" class="phase-content space-y-3">
                                    <% (round.matches || []).forEach((match, mIdx) => { %>
                                        <div class="bg-gray-800 rounded border match-card <%= match.status === 'completed' ? 'border-green-600' : 'border-gray-600' %>">
                                            <div class="bg-gray-750 p-2 flex justify-between items-center text-sm"><span class="text-gray-300">M<%= mIdx + 1 %></span><span class="match-status <%= match.status === 'completed' ? 'text-green-400' : 'text-orange-400' %> text-xs font-bold"><%= match.status === 'completed' ? 'âœ“' : 'â³' %></span></div>
                                            <div class="p-3">
                                                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center mb-3">
                                                    <div class="bg-gray-900 rounded p-2 border-l-4 border-purple-500 text-xs"><p class="text-purple-300 font-bold text-center mb-1"><%= match.team1 ? match.team1.name : 'Ã‰quipe 1' %></p><% (match.team1?.members || []).forEach(m => { %><p class="text-gray-300 truncate">â€¢ <%= m.pseudo || m.name %></p><% }); %></div>
                                                    <div class="bg-gradient-to-b from-gray-750 to-gray-900 rounded p-2 text-center border border-gray-600"><% if (match.status === 'completed') { %><div class="text-2xl font-bold"><span class="text-purple-400"><%= match.setsWonTeam1 || 0 %></span><span class="text-gray-400">-</span><span class="text-red-400"><%= match.setsWonTeam2 || 0 %></span></div><% } else { %><p class="text-gray-500 text-xs">â€”</p><% } %></div>
                                                    <div class="bg-gray-900 rounded p-2 border-l-4 border-red-500 text-xs"><p class="text-red-300 font-bold text-center mb-1"><%= match.team2 ? match.team2.name : 'Ã‰quipe 2' %></p><% (match.team2?.members || []).forEach(m => { %><p class="text-gray-300 truncate">â€¢ <%= m.pseudo || m.name %></p><% }); %></div>
                                                </div>
                                                <form class="record-score-form" data-tournament-id="<%= tournament.id %>" data-match-id="<%= match.id %>" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 4px; align-items: end;">
                                                    <input type="number" name="setsWonTeam1" value="<%= match.setsWonTeam1 || 0 %>" min="0" class="p-1 text-xs rounded bg-gray-700 text-white text-center border border-gray-600" required>
                                                    <input type="number" name="setsWonTeam2" value="<%= match.setsWonTeam2 || 0 %>" min="0" class="p-1 text-xs rounded bg-gray-700 text-white text-center border border-gray-600" required>
                                                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold rounded px-2 py-1 text-xs">âœï¸</button>
                                                </form>
                                            </div>
                                        </div>
                                    <% }); %>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                <% }); %>
            </div>
        <% } %>
    </div>
</div>

<script>
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const tabName = btn.getAttribute('data-tab');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(tabName).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => { b.style.background = 'rgba(55, 65, 81, 0.5)'; b.style.borderBottom = '1px solid rgb(75, 85, 99)'; });
        btn.style.background = 'rgba(59, 130, 246, 0.2)';
        btn.style.borderBottom = '2px solid rgb(59, 130, 246)';
    });
});

document.querySelectorAll('.phase-header, [data-target^="round"]').forEach(h => {
    h.addEventListener('click', () => {
        const target = h.getAttribute('data-target');
        const content = document.getElementById(target);
        const icon = h.querySelector('.toggle-icon');
        if (content && icon) {
            content.classList.toggle('hidden');
            icon.style.transform = content.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
        }
    });
});

document.querySelectorAll('.record-score-form').forEach(form => {
    form.addEventListener('submit', async e => {
        e.preventDefault();
        const tid = form.getAttribute('data-tournament-id');
        const mid = form.getAttribute('data-match-id');
        const s1 = parseInt(form.querySelector('input[name="setsWonTeam1"]').value);
        const s2 = parseInt(form.querySelector('input[name="setsWonTeam2"]').value);
        try {
            const r = await fetch(`/admin/tournaments/${tid}/king/matches/${mid}/record-result`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ setsWonTeam1: s1, setsWonTeam2: s2 }) });
            const d = await r.json();
            if (d.success) {
                const card = form.closest('.match-card');
                if (card) {
                    card.classList.remove('border-gray-600'); card.classList.add('border-green-600');
                    const status = card.querySelector('.match-status');
                    if (status) { status.classList.remove('text-orange-400'); status.classList.add('text-green-400'); status.textContent = 'âœ“'; }
                }
                form.style.display = 'none';
            }
        } catch (e) { alert('âŒ Erreur'); }
    });
});

const tid = document.getElementById('tournament-data')?.getAttribute('data-tournament-id');
['startPhase1Btn', 'startPhase2Btn', 'startPhase3Btn'].forEach(id => {
    const btn = document.getElementById(id);
    if (btn) btn.addEventListener('click', async () => {
        const ep = id === 'startPhase1Btn' ? 'start-phase-1' : id === 'startPhase2Btn' ? 'start-phase-2' : 'start-phase-3';
        if (confirm('Lancer?')) try { if ((await (await fetch(`/admin/tournaments/${tid}/king/${ep}`, { method: 'POST', headers: { 'Content-Type': 'application/json' } })).json()).success) { alert('âœ… LancÃ©!'); location.reload(); } } catch (e) { alert('âŒ Erreur'); }
    });
});

const setScores = document.getElementById('setAllMatchesScoresBtn');
if (setScores) setScores.addEventListener('click', async () => {
    if (confirm('ğŸ² Scores alÃ©atoires?')) try { if ((await (await fetch(`/admin/tournaments/${tid}/king/set-all-matches-scores`, { method: 'POST', headers: { 'Content-Type': 'application/json' } })).json()).success) { alert('âœ… GÃ©nÃ©rÃ©!'); location.reload(); } } catch (e) { alert('âŒ Erreur'); }
});

document.getElementById('updatePhase1ConfigForm')?.addEventListener('submit', async e => {
    e.preventDefault();
    try { if ((await (await fetch(`/admin/tournaments/${tid}/king/update-config`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ teamSize: parseInt(document.getElementById('phase1TeamSize').value), teamsPerPool: parseInt(document.getElementById('phase1TeamsPerPool').value), numRoundsPerPool: parseInt(document.getElementById('phase1NumRoundsPerPool').value) }) })).json()).success) { alert('âœ… SauvegardÃ©!'); location.reload(); } } catch (e) { alert('âŒ Erreur'); }
});

['resetPhase1Btn', 'resetPhase2Btn', 'resetPhase3Btn'].forEach((id, i) => {
    const btn = document.getElementById(id);
    if (btn) btn.addEventListener('click', async () => {
        if (confirm(`Reset P${i+1}?`)) try { if ((await (await fetch(`/admin/tournaments/${tid}/king/reset-phase-${i+1}`, { method: 'POST', headers: { 'Content-Type': 'application/json' } })).json()).success) { alert('âœ… RÃ©initialisÃ©!'); location.reload(); } } catch (e) { alert('âŒ Erreur'); }
    });
});
</script>

<style>
.phase-content { transition: all 0.3s ease; } .phase-content.hidden { display: none; } .toggle-icon { transition: transform 0.3s ease; }
.glass-card { background: rgba(17, 24, 39, 0.5); backdrop-filter: blur(10px); }
.overflow-y-auto::-webkit-scrollbar { width: 6px; } .overflow-y-auto::-webkit-scrollbar-track { background: rgba(55, 65, 81, 0.3); border-radius: 3px; }
.overflow-y-auto::-webkit-scrollbar-thumb { background: rgba(107, 114, 128, 0.6); border-radius: 3px; } .overflow-y-auto::-webkit-scrollbar-thumb:hover { background: rgba(107, 114, 128, 0.8); }
</style>
