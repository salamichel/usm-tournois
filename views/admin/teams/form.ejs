<h1 class="text-3xl font-bold mb-6"><%= team ? 'Modifier l\'Équipe' : 'Créer une Équipe' %></h1>

<form action="/admin/tournaments/<%= tournamentId %>/teams<%= team ? '/' + team.id : '' %>" method="POST" class="bg-white p-6 rounded-lg shadow-md">
    <input type="hidden" name="tournamentId" value="<%= tournamentId %>">
    <div class="mb-4">
        <label for="name" class="block text-gray-700 text-sm font-bold mb-2">Nom de l'équipe:</label>
        <input type="text" id="name" name="name" value="<%= team ? team.name : '' %>" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
    </div>

    <div class="mb-4">
        <label for="captainId" class="block text-gray-700 text-sm font-bold mb-2">Capitaine:</label>
        <select id="captainId" name="captainId" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
            <option value="">Sélectionner un capitaine</option>
            <% allUsers.forEach(user => { %>
                <option value="<%= user.id %>" data-pseudo="<%= user.pseudo %>" <%= team && team.captainId === user.id ? 'selected' : '' %>>
                    <%= user.pseudo %> (<%= user.id %>)
                </option>
            <% }); %>
        </select>
    </div>

    <div class="mb-6">
        <label class="block text-gray-700 text-sm font-bold mb-2">Membres de l'équipe:</label>
        <div class="flex items-center mb-2">
            <select id="availableMembers" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mr-2">
                <option value="">Sélectionner un membre à ajouter</option>
                <% allUsers.forEach(user => { %>
                    <option value="<%= user.id %>" data-pseudo="<%= user.pseudo %>">
                        <%= user.pseudo %> (<%= user.id %>)
                    </option>
                <% }); %>
            </select>
            <button type="button" id="addMemberBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                Ajouter
            </button>
        </div>
        <ul id="teamMembersList" class="border rounded p-3 bg-gray-50">
            <% if (team && team.members) { %>
                <% team.members.forEach(member => { %>
                    <li class="flex justify-between items-center py-1 px-2 border-b last:border-b-0" data-member-user-id="<%= member.userId %>" data-member-pseudo="<%= member.pseudo %>" data-member-level="<%= member.level %>">
                        <span><%= member.pseudo %> (<%= member.userId %>) - Niveau: <%= member.level %></span>
                        <button type="button" class="remove-member-btn text-red-500 hover:text-red-700 font-bold text-sm">X</button>
                    </li>
                <% }); %>
            <% } %>
        </ul>
        <input type="hidden" name="members" id="membersInput">
    </div>

    <div class="flex items-center justify-end">
        <a href="/admin/tournaments/<%= tournamentId %>/teams" class="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800 mr-4">
            Annuler
        </a>
        <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
            <%= team ? 'Mettre à jour' : 'Créer' %> l'Équipe
        </button>
    </div>
</form>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const addMemberBtn = document.getElementById('addMemberBtn');
        const availableMembersSelect = document.getElementById('availableMembers');
        const teamMembersList = document.getElementById('teamMembersList');
        const membersInput = document.getElementById('membersInput');
        const captainIdSelect = document.getElementById('captainId');

        // Fonction pour mettre à jour le champ caché des membres
        function updateMembersInput() {
            const currentMembers = [];
            teamMembersList.querySelectorAll('li').forEach(li => {
                currentMembers.push({
                    userId: li.dataset.memberUserId,
                    pseudo: li.dataset.memberPseudo,
                    level: li.dataset.memberLevel
                });
            });
            membersInput.value = JSON.stringify(currentMembers); // Envoyer un tableau d'objets complets
        }

        // Initialiser le champ caché avec les membres existants
        updateMembersInput();

        // Ajouter un membre
        addMemberBtn.addEventListener('click', () => {
            const selectedOption = availableMembersSelect.options[availableMembersSelect.selectedIndex];
            const memberUserId = selectedOption.value;
            const memberPseudo = selectedOption.dataset.pseudo;
            const memberLevel = 'Débutant'; // Niveau par défaut lors de l'ajout

            if (memberUserId && !teamMembersList.querySelector(`[data-member-user-id="${memberUserId}"]`)) {
                const listItem = document.createElement('li');
                listItem.className = 'flex justify-between items-center py-1 px-2 border-b last:border-b-0';
                listItem.dataset.memberUserId = memberUserId;
                listItem.dataset.memberPseudo = memberPseudo;
                listItem.dataset.memberLevel = memberLevel;
                listItem.innerHTML = `
                    <span>${memberPseudo} (${memberUserId}) - Niveau: ${memberLevel}</span>
                    <button type="button" class="remove-member-btn text-red-500 hover:text-red-700 font-bold text-sm">X</button>
                `;
                teamMembersList.appendChild(listItem);
                updateMembersInput();
            }
        });

        // Retirer un membre
        teamMembersList.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-member-btn')) {
                const listItem = e.target.closest('li');
                const memberUserIdToRemove = listItem.dataset.memberUserId;
                const captainId = captainIdSelect.value;

                if (memberUserIdToRemove === captainId) {
                    alert('Le capitaine ne peut pas être retiré de l\'équipe.');
                    return;
                }

                listItem.remove();
                updateMembersInput();
            }
        });

        // Mettre à jour le champ caché lorsque le capitaine change (pour s'assurer qu'il est toujours dans la liste)
        captainIdSelect.addEventListener('change', () => {
            const newCaptainId = captainIdSelect.value;
            const currentMembers = Array.from(teamMembersList.querySelectorAll('li')).map(li => li.dataset.memberUserId);

            // Si le nouveau capitaine n'est pas déjà dans la liste des membres, l'ajouter
            if (newCaptainId && !currentMembers.includes(newCaptainId)) {
                const captainOption = availableMembersSelect.querySelector(`option[value="${newCaptainId}"]`);
                if (captainOption) {
                    const captainPseudo = captainOption.dataset.pseudo;
                    const captainLevel = 'Débutant'; // Niveau par défaut pour le capitaine
                    const listItem = document.createElement('li');
                    listItem.className = 'flex justify-between items-center py-1 px-2 border-b last:border-b-0';
                    listItem.dataset.memberUserId = newCaptainId;
                    listItem.dataset.memberPseudo = captainPseudo;
                    listItem.dataset.memberLevel = captainLevel;
                    listItem.innerHTML = `
                        <span>${captainPseudo} (${newCaptainId}) - Niveau: ${captainLevel}</span>
                        <button type="button" class="remove-member-btn text-red-500 hover:text-red-700 font-bold text-sm">X</button>
                    `;
                    teamMembersList.prepend(listItem); // Ajouter le capitaine en haut de la liste
                }
            }
            updateMembersInput();
        });
    });
</script>
