<!-- Google tag (gtag.js) -->
<% if (googleAnalyticsId) { %>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=<%= googleAnalyticsId %>"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', '<%= googleAnalyticsId %>');
</script>
<% } %>

<header class="sticky top-0 z-50 glass-card" id="app-header">
    <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
            <a href="/" class="text-2xl font-bold text-white flex items-center">
                <i class="fas fa-volleyball text-yellow-500 mr-3"></i>
                <span>USM Tournois Master</span>
            </a>
            <div class="flex items-center">
                <!-- Bouton Hamburger pour mobile -->
                <div class="md:hidden flex items-center">
                    <button id="mobile-menu-button" type="button"
                        class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white"
                        aria-controls="mobile-menu" aria-expanded="false">
                        <span class="sr-only">Ouvrir le menu principal</span>
                        <i class="fas fa-bars h-6 w-6"></i>
                    </button>
                </div>

                <!-- Navigation principale (desktop) -->
                <div class="hidden md:flex md:items-center md:space-x-4 ml-4">
                    <a href="/" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Tournois</a>
                    <% if (currentUser) { %>
                    <a href="/mon-compte"
                        class="<%= path === '/mon-compte' ? 'bg-gray-900 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white' %> px-3 py-2 rounded-md text-sm font-medium"
                        aria-current="<%= path === '/mon-compte' ? 'page' : '' %>">Mon Tableau de Bord</a>
                    <% } %>
                    <% if (currentUser && currentUser.role === 'admin') { %>
                    <div class="relative">
                        <button id="admin-menu-btn"
                            class="<%= path.startsWith('/admin') ? 'bg-gray-900 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white' %> px-3 py-2 rounded-md text-sm font-medium flex items-center space-x-1">
                            <span>Admin</span>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="admin-dropdown"
                            class="hidden absolute left-0 mt-2 w-48 origin-top-left rounded-md bg-[#161b22] shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none">
                            <div class="py-1">
                                <a href="/admin/dashboard"
                                    class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Tableau de Bord</a>
                                <a href="/admin/tournaments"
                                    class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Gérer les Tournois</a>
                                <a href="/admin/teams"
                                    class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Gérer les Équipes</a>
                                <a href="/admin/users"
                                    class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Gérer les Utilisateurs</a>
                            </div>
                        </div>
                    </div>
                    <% } %>
                </div>

                <!-- Menus utilisateur et connexion (desktop) -->
                <div class="hidden md:flex md:items-center md:ml-auto">
                    <% if (currentUser) { %>
                        <div class="relative">
                            <button id="user-menu-btn"
                                class="flex items-center space-x-2 p-1 rounded-full hover:bg-gray-800">
                                <img class="h-8 w-8 rounded-full" src="<%= currentUser.avatar ? encodeURI(currentUser.avatar) : `https://placehold.co/100x100/${Math.floor(Math.random() * 16777215).toString(16)}/white?text=${currentUser.pseudo ? currentUser.pseudo.charAt(0).toUpperCase() : '?'}` %>" alt="Avatar">
                                <span class="hidden sm:inline text-white font-medium">
                                    <%= currentUser.pseudo %>
                                </span>
                                <i class="fas fa-chevron-down text-xs text-gray-400"></i>
                            </button>
                            <div id="user-dropdown"
                                class="hidden absolute right-0 mt-2 w-48 origin-top-right rounded-md bg-[#161b22] shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none">
                                <div class="py-1">
                                    <a href="/mon-profil"
                                        class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Mon Profil</a>
                                    <a href="/changer-mot-de-passe"
                                        class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Changer le mot de passe</a>
                                    <a href="#" id="logout-btn"
                                        class="block px-4 py-2 text-sm text-red-400 hover:bg-gray-700">Déconnexion</a>
                                </div>
                            </div>
                        </div>
                        <% } else { %>
                            <a href="/login"
                                class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Connexion</a>
                            <% } %>
                </div>
            </div>
        </div>

        <!-- Menu mobile, bascule en fonction de l'état du menu -->
        <div class="md:hidden hidden" id="mobile-menu">
            <div class="px-4 py-3 space-y-2">
                <a href="/" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Tournois</a>
                <% if (currentUser) { %>
                <a href="/mon-compte"
                    class="<%= path === '/mon-compte' ? 'bg-gray-900 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white' %> block px-3 py-2 rounded-md text-base font-medium"
                    aria-current="<%= path === '/mon-compte' ? 'page' : '' %>">Mon Tableau de Bord</a>
                <% } %>
                <% if (currentUser && currentUser.role === 'admin') { %>
                <div class="relative">
                    <button id="mobile-admin-menu-btn"
                        class="<%= path.startsWith('/admin') ? 'bg-gray-900 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white' %> block px-3 py-2 rounded-md text-base font-medium w-full text-left flex items-center justify-between">
                        <span>Admin</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <div id="mobile-admin-dropdown" class="hidden pl-4 py-1 space-y-1">
                        <a href="/admin/dashboard"
                            class="block px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 rounded-md">Tableau de Bord</a>
                        <a href="/admin/tournaments"
                            class="block px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 rounded-md">Gérer les Tournois</a>
                        <a href="/admin/teams"
                            class="block px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 rounded-md">Gérer les Équipes</a>
                        <a href="/admin/users"
                            class="block px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 rounded-md">Gérer les Utilisateurs</a>
                    </div>
                </div>
                <% } %>

                <% if (currentUser) { %>
                    <div class="relative">
                        <button id="mobile-user-menu-btn"
                            class="flex items-center justify-between w-full px-3 py-2 rounded-md text-base font-medium text-white hover:bg-gray-700">
                            <div class="flex items-center space-x-2">
                                <img class="h-8 w-8 rounded-full" src="<%= currentUser.avatar ? encodeURI(currentUser.avatar) : `https://placehold.co/100x100/${Math.floor(Math.random() * 16777215).toString(16)}/white?text=${currentUser.pseudo ? currentUser.pseudo.charAt(0).toUpperCase() : '?'}` %>" alt="Avatar">
                                <span>
                                    <%= currentUser.pseudo %>
                                </span>
                            </div>
                            <i class="fas fa-chevron-down text-xs text-gray-400"></i>
                        </button>
                        <div id="mobile-user-dropdown" class="hidden pl-4 py-1 space-y-1">
                            <a href="/mon-profil"
                                class="block px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 rounded-md">Mon Profil</a>
                            <a href="/changer-mot-de-passe"
                                class="block px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 rounded-md">Changer le mot de passe</a>
                            <a href="#" id="logout-btn-mobile"
                                class="block px-3 py-2 text-sm text-red-400 hover:bg-gray-700 rounded-md">Déconnexion</a>
                        </div>
                    </div>
                    <% } else { %>
                        <a href="/login"
                            class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Connexion</a>
                        <% } %>
            </div>
        </div>
    </nav>
</header>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const adminMenuBtn = document.getElementById('admin-menu-btn');
        const adminDropdown = document.getElementById('admin-dropdown');
        const userMenuBtn = document.getElementById('user-menu-btn');
        const userDropdown = document.getElementById('user-dropdown');

        const mobileAdminMenuBtn = document.getElementById('mobile-admin-menu-btn');
        const mobileAdminDropdown = document.getElementById('mobile-admin-dropdown');
        const mobileUserMenuBtn = document.getElementById('mobile-user-menu-btn');
        const mobileUserDropdown = document.getElementById('mobile-user-dropdown');
        const logoutBtnMobile = document.getElementById('logout-btn-mobile');
        const logoutBtnDesktop = document.getElementById('logout-btn');

        // Toggle mobile menu
        if (mobileMenuButton) {
            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
                const isExpanded = mobileMenuButton.getAttribute('aria-expanded') === 'true';
                mobileMenuButton.setAttribute('aria-expanded', !isExpanded);
            });
        }

        // Toggle desktop admin dropdown
        if (adminMenuBtn) {
            adminMenuBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                adminDropdown.classList.toggle('hidden');
            });
        }

        // Toggle desktop user dropdown
        if (userMenuBtn) {
            userMenuBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                userDropdown.classList.toggle('hidden');
            });
        }

        // Toggle mobile admin dropdown
        if (mobileAdminMenuBtn) {
            mobileAdminMenuBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                mobileAdminDropdown.classList.toggle('hidden');
            });
        }

        // Toggle mobile user dropdown
        if (mobileUserMenuBtn) {
            mobileUserMenuBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                mobileUserDropdown.classList.toggle('hidden');
            });
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (event) => {
            if (adminDropdown && !adminMenuBtn.contains(event.target) && !adminDropdown.contains(event.target)) {
                adminDropdown.classList.add('hidden');
            }
            if (userDropdown && !userMenuBtn.contains(event.target) && !userDropdown.contains(event.target)) {
                userDropdown.classList.add('hidden');
            }
            if (mobileAdminDropdown && mobileAdminMenuBtn && !mobileAdminMenuBtn.contains(event.target) && !mobileAdminDropdown.contains(event.target)) {
                mobileAdminDropdown.classList.add('hidden');
            }
            if (mobileUserDropdown && mobileUserMenuBtn && !mobileUserMenuBtn.contains(event.target) && !mobileUserDropdown.contains(event.target)) {
                mobileUserDropdown.classList.add('hidden');
            }
        });

        // Logout functionality
        const handleLogout = async (event) => {
            event.preventDefault();
            try {
                const response = await fetch('/logout', { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    window.location.href = '/login';
                } else {
                    alert('Erreur lors de la déconnexion.');
                }
            } catch (error) {
                console.error('Erreur de déconnexion:', error);
                alert('Une erreur est survenue lors de la déconnexion.');
            }
        };

        if (logoutBtnDesktop) {
            logoutBtnDesktop.addEventListener('click', handleLogout);
        }
        if (logoutBtnMobile) {
            logoutBtnMobile.addEventListener('click', handleLogout);
        }
    });
</script>
