<!-- Main Content -->
<main class="container mx-auto p-4 sm:p-6 lg:p-8">

    <!-- Welcome Header -->
    <div class="mb-10 flex justify-between items-center">
        <h1 class="text-4xl font-extrabold text-white">Tableau de bord de <%= currentUser.pseudo %></h1>
        <button id="createTeamBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors duration-200">
            <i class="fas fa-plus-circle mr-2"></i>Créer une équipe
        </button>
    </div>
    <p class="text-lg text-gray-400 mt-2 mb-8">Bienvenue ! Voici un résumé de vos activités.</p>

    <div class="space-y-12">

        <!-- Section Mes Équipes -->
        <section>
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                <i class="fas fa-crown text-yellow-400 mr-4"></i>Mes Équipes
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <% if (userTeams && userTeams.length > 0) { %>
                    <% userTeams.forEach(team => { %>
                        <div class="glass-card rounded-lg p-6 flex flex-col justify-between">
                            <div>
                                <div class="mb-4">
                                    <p class="text-sm text-gray-400">Tournoi "<%= team.tournamentName %>"</p>
                                    <h3 class="text-xl font-bold text-white"><%= team.name %></h3>
                                </div>
                                <div class="space-y-2 text-sm">
                                    <p class="font-semibold text-gray-300">Membres (<%= team.members.length %>/<%= team.maxMembers %>) :</p>
                                    <ul class="list-disc list-inside text-gray-400">
                                        <% team.members.forEach(member => { %>
                                            <li><%= member.pseudo %> (Niveau: <%= member.level %>)</li>
                                        <% }); %>
                                    </ul>
                                    <% if (team.recruitmentOpen) { %>
                                        <p class="text-green-400 font-semibold"><i class="fas fa-user-plus mr-2"></i>Recrutement ouvert</p>
                                    <% } else { %>
                                        <p class="text-red-400 font-semibold"><i class="fas fa-user-minus mr-2"></i>Recrutement fermé</p>
                                    <% } %>
                                </div>
                            </div>
                            <div class="mt-6">
                                <a href="/gestion-equipe/<%= team.id %>?tournamentId=<%= team.tournamentId %>" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-center transition-colors duration-200">
                                    <i class="fas fa-users-cog mr-2"></i>Gérer l'équipe
                                </a>
                            </div>
                            <!-- Section d'inscription/désinscription aux tournois (Collapsable) -->
                            <div class="mt-6 border-t border-gray-700 pt-4">
                                <button class="flex items-center justify-between w-full text-white font-semibold py-2 px-0 text-left toggle-tournaments-status">
                                    <span><i class="fas fa-calendar-alt mr-2"></i>Inscrire/Désinscrire aux tournois</span>
                                    <i class="fas fa-chevron-down transition-transform duration-200"></i>
                                </button>
                                <div class="tournaments-status-content hidden space-y-3 mt-3">
                                    <% team.tournamentsStatus.forEach(tournamentStatus => { %>
                                        <% 
                                            const now = new Date();
                                            const eventForStatus = activeTournaments.find(t => t.id === tournamentStatus.tournamentId);
                                            const registrationStarts = eventForStatus && eventForStatus.registrationStartDateTime ? eventForStatus.registrationStartDateTime.toDate() : new Date(0);
                                            const isRegistrationUpcoming = eventForStatus && eventForStatus.registrationsOpen && now < registrationStarts;
                                        %>
                                        <div class="flex items-center justify-between p-3 rounded-md bg-gray-700">
                                            <span class="text-gray-300"><%= tournamentStatus.tournamentName %></span>
                                            <% if (tournamentStatus.isRegistered) { %>
                                                <button class="btn-danger text-white font-bold py-1 px-3 rounded-lg text-sm unregister-team-btn"
                                                        data-team-id="<%= team.id %>"
                                                        data-tournament-id="<%= tournamentStatus.tournamentId %>">
                                                    Désinscrire
                                                </button>
                                            <% } else if (isRegistrationUpcoming) { %>
                                                <span class="text-yellow-400 text-sm">Inscriptions le <%= registrationStarts.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' }) %></span>
                                            <% } else if (tournamentStatus.isOnWaitingList) { %>
                                                <button class="btn-danger text-white font-bold py-1 px-3 rounded-lg text-sm unregister-waiting-list-btn"
                                                        data-team-id="<%= team.id %>"
                                                        data-tournament-id="<%= tournamentStatus.tournamentId %>">
                                                    Quitter liste d'attente
                                                </button>
                                            <% } else if (tournamentStatus.status === 'Ouvert') { %>
                                                <button class="btn-success text-white font-bold py-1 px-3 rounded-lg text-sm register-team-btn"
                                                        data-team-id="<%= team.id %>"
                                                        data-tournament-id="<%= tournamentStatus.tournamentId %>">
                                                    Inscrire
                                                </button>
                                            <% } else if (tournamentStatus.status === "Liste d'attente") { %>
                                                <button class="btn-purple text-white font-bold py-1 px-3 rounded-lg text-sm register-waiting-list-btn"
                                                        data-team-id="<%= team.id %>"
                                                        data-tournament-id="<%= tournamentStatus.tournamentId %>">
                                                    Rejoindre liste d'attente
                                                </button>
                                            <% } else { %>
                                                <span class="text-gray-500 text-sm">Complet</span>
                                            <% } %>
                                        </div>
                                    <% }); %>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div class="glass-card rounded-lg p-8 text-center col-span-full">
                        <i class="fas fa-exclamation-circle text-4xl text-gray-500 mb-4"></i>
                        <p class="text-gray-400">Vous n'êtes capitaine d'aucune équipe pour le moment.</p>
                    </div>
                <% } %>
            </div>
        </section>

        <hr class="border-gray-800">

        <!-- Section Tournois Inscrits -->
        <section>
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                <i class="fas fa-user-friends text-blue-400 mr-4"></i>Mes Tournois Inscrits
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <% if (registeredEvents && registeredEvents.length > 0) { %>
                    <% registeredEvents.forEach(event => { %>
                        <%- include('../partials/tournament-card', { event: event, user: user }) %>
                    <% }); %>
                <% } else { %>
                    <div class="glass-card rounded-lg p-8 text-center col-span-full">
                        <i class="fas fa-exclamation-circle text-4xl text-gray-500 mb-4"></i>
                        <p class="text-gray-400">Vous n'êtes inscrit à aucun tournoi en tant que joueur libre pour le moment.</p>
                        <a href="/" class="mt-4 btn-secondary text-white font-semibold py-2 px-4 rounded-lg">
                            Découvrir les tournois
                        </a>
                    </div>
                <% } %>
            </div>
        </section>

        <hr class="border-gray-800">

        <!-- Section Mes Matchs -->
        <section>
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                <i class="fas fa-volleyball-ball text-green-400 mr-4"></i>Mes Matchs
            </h2>
            <% if (userMatches && userMatches.length > 0) { %>
                <div class="overflow-x-auto glass-card rounded-lg p-6">
                    <table class="w-full text-sm text-left">
                        <thead class="table-header">
                            <tr>
                                <th class="p-3 rounded-l-lg">Tournoi</th>
                                <th class="p-3">Type</th>
                                <th class="p-3">Poule</th>
                                <th class="p-3">Équipe 1</th>
                                <th class="p-3">Équipe 2</th>
                                <th class="text-center p-3">Sets</th>
                                <th class="text-center p-3">Vainqueur</th>
                                <th class="text-center p-3 rounded-r-lg">Statut</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-300">
                            <% userMatches.forEach(match => { %>
                                <%
                                    let team1SetsWon = 0;
                                    let team2SetsWon = 0;
                                    if (match.sets && Array.isArray(match.sets)) {
                                        match.sets.forEach(set => {
                                            if (set.score1 !== null && set.score2 !== null) {
                                                if (set.score1 > set.score2) team1SetsWon++;
                                                else if (set.score2 > set.score1) team2SetsWon++;
                                            }
                                        });
                                    }
                                    let winnerName = 'N/A';
                                    if (match.status === 'completed') {
                                        if (team1SetsWon > team2SetsWon) {
                                            winnerName = match.team1Name;
                                        } else if (team2SetsWon > team1SetsWon) {
                                            winnerName = match.team2Name;
                                        } else {
                                            winnerName = 'Égalité'; // Ou une autre indication pour les matchs nuls
                                        }
                                    }
                                %>
                                <tr class="border-b border-gray-700 last:border-b-0">
                                    <td class="p-3"><a href="/tournoi/<%= match.tournamentId %>" class="text-blue-400 hover:underline"><%= match.tournamentName %></a></td>
                                    <td class="p-3"><%= match.type === 'pool' ? 'Poule' : 'Éliminatoire' %></td>
                                    <td class="p-3"><%= match.poolName || 'N/A' %></td>
                                    <td class="p-3"><%= match.team1Name %></td>
                                    <td class="p-3"><%= match.team2Name %></td>
                                    <td class="text-center p-3">
                                        <% if (match.sets && match.sets.length > 0) { %>
                                            <% match.sets.forEach(set => { %>
                                                <span class="font-bold"><%= set.score1 %> - <%= set.score2 %></span><br>
                                            <% }); %>
                                        <% } else { %>
                                            <span>N/A</span>
                                        <% } %>
                                    </td>
                                    <td class="text-center p-3">
                                        <span class="font-bold text-green-400"><%= winnerName %></span>
                                    </td>
                                    <td class="text-center p-3">
                                        <span class="px-2 py-1 rounded-full text-xs font-semibold
                                            <% if (match.status === 'completed') { %> bg-green-600 text-white
                                            <% } else if (match.status === 'in_progress') { %> bg-yellow-600 text-white
                                            <% } else { %> bg-gray-600 text-white <% } %>">
                                            <%= match.status %>
                                        </span>
                                        <% if (match.status !== 'completed' && match.team1CaptainId === currentUser.uid) { %>
                                            <button class="btn-primary text-white font-bold py-1 px-3 rounded-lg text-xs mt-2 open-score-modal"
                                                    data-event-id="<%= match.eventId %>"
                                                    data-match-id="<%= match.id %>"
                                                    data-match-type="<%= match.type %>"
                                                    data-pool-id="<%= match.poolId || '' %>"
                                                    data-team1-name="<%= match.team1Name %>"
                                                    data-team2-name="<%= match.team2Name %>"
                                                    data-sets='<%= JSON.stringify(match.sets) %>'
                                                    data-tie-break-enabled="<%= match.tieBreakEnabled %>"
                                                    data-sets-to-win="<%= match.setsToWin %>">
                                                Saisir les scores
                                            </button>
                                        <% } %>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            <% } else if (userMatches && userMatches.length === 0) { %>
                <div class="glass-card rounded-lg p-8 text-center col-span-full">
                    <i class="fas fa-exclamation-circle text-4xl text-gray-500 mb-4"></i>
                    <p class="text-gray-400">Vous n'avez pas encore de matchs enregistrés.</p>
                </div>
            <% } else { %>
                <div class="glass-card rounded-lg p-8 text-center col-span-full">
                    <i class="fas fa-exclamation-circle text-4xl text-gray-500 mb-4"></i>
                    <p class="text-gray-400">Chargement des matchs...</p>
                </div>
            <% } %>
        </section>
    </div>
</main>

<%- include('../partials/modal-template', {
    modalId: 'createTeamModal',
    closeButtonId: 'closeTeamModal',
    title: 'Créer une nouvelle équipe',
    content: `
        <form id="createTeamForm" class="space-y-4">
            <div>
                <label for="newTeamName" class="block text-gray-300 text-sm font-bold mb-2">Nom de l\'équipe:</label>
                <input type="text" id="newTeamName" name="teamName" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline bg-gray-700 border-gray-600 text-white" required>
            </div>
            <div>
                <label for="tournamentSelect" class="block text-gray-300 text-sm font-bold mb-2">Sélectionner un tournoi:</label>
                <select id="tournamentSelect" name="tournamentId" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline bg-gray-700 border-gray-600 text-white" required>
                    <option value="" class="text-gray-900 bg-gray-200">-- Choisir un tournoi --</option>
                    ${activeTournaments && activeTournaments.length > 0 ?
                        activeTournaments.map(tournament => `
                            <option value="${tournament.id}" ${tournament.status === 'Complet' || tournament.status === "Liste d'attente" ? 'disabled' : ''} class="text-gray-900 bg-gray-200">${tournament.name} (${tournament.minPlayersPerTeam} - ${tournament.playersPerTeam} joueurs par équipe)</option>
                        `).join('')
                        : '<option value="" disabled class="text-gray-900 bg-gray-200">Aucun tournoi disponible</option>'
                    }
                </select>
            </div>
            <div class="flex justify-end">
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Créer l\'équipe
                </button>
            </div>
            <div id="createTeamMessage" class="mt-4 text-center font-semibold"></div>
        </form>
    `
}) %>

<%- include('../partials/modal-template', {
    modalId: 'scoreModal',
    closeButtonId: 'closeScoreModal',
    title: 'Saisir les scores du match',
    content: `
        <p class="text-gray-300 mb-4 text-center" id="matchTeamsDisplay"></p>
        <form id="scoreForm" class="space-y-4">
            <input type="hidden" id="scoreModalEventId" name="eventId">
            <input type="hidden" id="scoreModalMatchId" name="matchId">
            <input type="hidden" id="scoreModalMatchType" name="matchType">
            <input type="hidden" id="scoreModalPoolId" name="poolId">

            <div id="setsContainer" class="space-y-3">
                <!-- Les champs de sets seront ajoutés ici par JavaScript -->
            </div>

            <div class="flex justify-end">
                <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Valider les scores
                </button>
            </div>
            <div id="scoreMessage" class="mt-4 text-center font-semibold"></div>
        </form>
    `
}) %>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Gestion de l'inscription d'équipe
        const registerTeamButtons = document.querySelectorAll('.register-team-btn');
        if (registerTeamButtons.length > 0) {
            registerTeamButtons.forEach(button => {
                button.addEventListener('click', async (e) => {
                    const teamId = e.target.dataset.teamId;
                    const tournamentId = e.target.dataset.tournamentId;

                    try {
                        const response = await fetch(`/tournoi/${tournamentId}/register-team`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ teamId }),
                        });

                        if (response.ok) {
                            // Si la réponse est OK (statut 2xx), le serveur gère probablement une redirection avec un message flash.
                            // On recharge simplement la page pour que le message flash s'affiche.
                            location.reload();
                        } else {
                            // Si la réponse n'est pas OK, tenter de lire le message d'erreur du serveur.
                            const errorData = await response.json();
                            console.error('Erreur lors de l\'inscription de l\'équipe:', errorData.message || 'Erreur inconnue');
                            // Afficher un message d'erreur à l'utilisateur si nécessaire, ou recharger pour un message flash générique
                            location.reload(); // Recharger pour afficher un message flash générique si le serveur le gère
                        }
                    } catch (error) {
                        console.error('Erreur lors de l\'inscription de l\'équipe:', error);
                        // En cas d'erreur réseau ou si response.json() échoue pour une raison inattendue (ex: réponse non-JSON),
                        // on recharge pour afficher un message flash générique si le serveur le gère.
                        location.reload(); 
                    }
                });
            });
        }

        // Gestion de la désinscription d'équipe
        const unregisterTeamButtons = document.querySelectorAll('.unregister-team-btn');
        if (unregisterTeamButtons.length > 0) {
            unregisterTeamButtons.forEach(button => {
                button.addEventListener('click', async (e) => {
                    const teamId = e.target.dataset.teamId;
                    const tournamentId = e.target.dataset.tournamentId;

                    if (!confirm('Êtes-vous sûr de vouloir désinscrire cette équipe de ce tournoi ?')) {
                        return;
                    }

                    try {
                        const response = await fetch(`/tournoi/${tournamentId}/unregister-team`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ teamId }),
                        });

                        if (response.ok) {
                            location.reload();
                        } else {
                            const errorData = await response.json();
                            console.error('Erreur lors de la désinscription de l\'équipe:', errorData.message || 'Erreur inconnue');
                            location.reload();
                        }
                    } catch (error) {
                        console.error('Erreur lors de la désinscription de l\'équipe:', error);
                        location.reload();
                    }
                });
            });
        }

        // Gestion de l'inscription à la liste d'attente
        const registerWaitingListButtons = document.querySelectorAll('.register-waiting-list-btn');
        if (registerWaitingListButtons.length > 0) {
            registerWaitingListButtons.forEach(button => {
                button.addEventListener('click', async (e) => {
                    const teamId = e.target.dataset.teamId;
                    const tournamentId = e.target.dataset.tournamentId;

                    try {
                        const response = await fetch(`/tournoi/${tournamentId}/register-team`, { // Réutilise la même route car la logique est gérée côté serveur
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ teamId }),
                        });

                        if (response.ok) {
                            location.reload();
                        } else {
                            const errorData = await response.json();
                            console.error('Erreur lors de l\'inscription à la liste d\'attente:', errorData.message || 'Erreur inconnue');
                            location.reload();
                        }
                    } catch (error) {
                        console.error('Erreur lors de l\'inscription à la liste d\'attente:', error);
                        location.reload();
                    }
                });
            });
        }

        // Gestion de la désinscription de la liste d'attente
        const unregisterWaitingListButtons = document.querySelectorAll('.unregister-waiting-list-btn');
        if (unregisterWaitingListButtons.length > 0) {
            unregisterWaitingListButtons.forEach(button => {
                button.addEventListener('click', async (e) => {
                    const teamId = e.target.dataset.teamId;
                    const tournamentId = e.target.dataset.tournamentId;

                    if (!confirm('Êtes-vous sûr de vouloir quitter la liste d\'attente pour ce tournoi ?')) {
                        return;
                    }

                    try {
                        const response = await fetch(`/tournoi/${tournamentId}/unregister-waiting-list-team`, { // Nouvelle route pour désinscription de la liste d'attente
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ teamId }),
                        });

                        if (response.ok) {
                            location.reload();
                        } else {
                            const errorData = await response.json();
                            console.error('Erreur lors de la désinscription de la liste d\'attente:', errorData.message || 'Erreur inconnue');
                            location.reload();
                        }
                    } catch (error) {
                        console.error('Erreur lors de la désinscription de la liste d\'attente:', error);
                        location.reload();
                    }
                });
            });
        }

    // Modal pour la création d'équipe
    const createTeamModal = document.getElementById('createTeamModal');

    if (createTeamModal) { // N'initialiser le modal que si le modal existe
        const createTeamBtn = document.getElementById('createTeamBtn');
        const closeTeamModal = document.getElementById('closeTeamModal');
        const createTeamForm = document.getElementById('createTeamForm');
        const teamNameInput = document.getElementById('newTeamName');
        const tournamentSelect = document.getElementById('tournamentSelect');
        const createTeamMessage = document.getElementById('createTeamMessage');

        if (createTeamBtn) { // Le bouton peut ne pas exister si l'utilisateur a déjà des équipes
            createTeamBtn.addEventListener('click', () => {
                createTeamModal.classList.remove('hidden');
            });
        }

        closeTeamModal.addEventListener('click', () => {
            createTeamModal.classList.add('hidden');
            createTeamMessage.textContent = '';
        });

        createTeamForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const teamName = teamNameInput.value;
            const tournamentId = tournamentSelect.value;

            if (!teamName || !tournamentId) {
                createTeamMessage.textContent = 'Veuillez remplir tous les champs.';
                createTeamMessage.className = 'mt-4 text-center font-semibold text-red-500';
                return;
            }

            try {
                const response = await fetch(`/tournoi/${tournamentId}/create-team`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ teamName }),
                });
                const data = await response.json();

                if (data.success) {
                    createTeamMessage.textContent = data.message;
                    createTeamMessage.className = 'mt-4 text-center font-semibold text-green-500';
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    createTeamMessage.textContent = data.message;
                    createTeamMessage.className = 'mt-4 text-center font-semibold text-red-500';
                }
            } catch (error) {
                console.error('Erreur lors de la création de l\'équipe:', error);
                createTeamMessage.textContent = 'Une erreur est survenue lors de la création de l\'équipe.';
                createTeamMessage.className = 'mt-4 text-center font-semibold text-red-500';
            }
        });
    }
    });

    // Gestion des sections collapsables pour les statuts d'inscription aux tournois
    const toggleButtons = document.querySelectorAll('.toggle-tournaments-status');
    toggleButtons.forEach(button => {
        button.addEventListener('click', () => {
            const content = button.nextElementSibling; // Le contenu est l'élément suivant le bouton
            const icon = button.querySelector('i.fa-chevron-down');

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        });
    });

    // Gestion du modal de saisie des scores
    const scoreModal = document.getElementById('scoreModal');
    const closeScoreModal = document.getElementById('closeScoreModal');
    const scoreForm = document.getElementById('scoreForm');
    const scoreModalEventId = document.getElementById('scoreModalEventId');
    const scoreModalMatchId = document.getElementById('scoreModalMatchId');
    const scoreModalMatchType = document.getElementById('scoreModalMatchType');
    const scoreModalPoolId = document.getElementById('scoreModalPoolId');
    const matchTeamsDisplay = document.getElementById('matchTeamsDisplay');
    const setsContainer = document.getElementById('setsContainer');
    const scoreMessage = document.getElementById('scoreMessage');

    document.querySelectorAll('.open-score-modal').forEach(button => {
        button.addEventListener('click', (e) => {
            const eventId = e.target.dataset.eventId;
            const matchId = e.target.dataset.matchId;
            const matchType = e.target.dataset.matchType;
            const poolId = e.target.dataset.poolId;
            const team1Name = e.target.dataset.team1Name;
            const team2Name = e.target.dataset.team2Name;
            const sets = JSON.parse(e.target.dataset.sets);
            const tieBreakEnabled = e.target.dataset.tieBreakEnabled === 'true'; // Convertir en booléen
            const setsToWin = parseInt(e.target.dataset.setsToWin); // Convertir en nombre

            scoreModalEventId.value = eventId;
            scoreModalMatchId.value = matchId;
            scoreModalMatchType.value = matchType;
            scoreModalPoolId.value = poolId;
            matchTeamsDisplay.textContent = `${team1Name} vs ${team2Name}`;
            setsContainer.innerHTML = ''; // Clear previous sets

            let team1SetsWon = 0;
            let team2SetsWon = 0;

            // Dynamically create input fields for each set
            for (let i = 0; i < sets.length; i++) {
                const set = sets[i];
                const setDiv = document.createElement('div');
                setDiv.className = 'flex items-center justify-between space-x-2';
                setDiv.innerHTML = `
                    <label class="text-gray-300 text-sm font-bold">Set ${i + 1}:</label>
                    <input type="number" name="sets[${i}][scoreTeam1]" value="${set.score1 !== undefined && set.score1 !== null ? set.score1 : ''}" class="w-1/3 shadow appearance-none border rounded py-2 px-3 leading-tight focus:outline-none focus:shadow-outline bg-gray-700 border-gray-600 text-white" placeholder="${team1Name}" required>
                    <span class="text-white">-</span>
                    <input type="number" name="sets[${i}][scoreTeam2]" value="${set.score2 !== undefined && set.score2 !== null ? set.score2 : ''}" class="w-1/3 shadow appearance-none border rounded py-2 px-3 leading-tight focus:outline-none focus:shadow-outline bg-gray-700 border-gray-600 text-white" placeholder="${team2Name}" required>
                `;
                setsContainer.appendChild(setDiv);

                if (set.score1 !== undefined && set.score1 !== null && set.score2 !== undefined && set.score2 !== null) {
                    if (set.score1 > set.score2) team1SetsWon++;
                    else if (set.score2 > set.score1) team2SetsWon++;
                }
            }

            // Logic for tie-break set if enabled and scores are tied
            if (tieBreakEnabled && team1SetsWon === team2SetsWon && team1SetsWon === (setsToWin - 1)) {
                const tieBreakSetDiv = document.createElement('div');
                tieBreakSetDiv.className = 'flex flex-col items-center w-full mt-4 pt-4 border-t border-gray-600';
                tieBreakSetDiv.innerHTML = `
                    <span class="text-base font-semibold text-gray-300 mb-2">Tie-break</span>
                    <div class="flex items-center justify-around w-full">
                        <div class="flex flex-col items-center w-5/12">
                            <span class="text-base text-gray-200 font-bold mb-1 truncate">${team1Name}</span>
                            <input type="number" name="sets[${sets.length}][scoreTeam1]" value="" class="w-24 bg-gray-700 border border-gray-600 rounded text-white text-center text-xl py-2" min="0" required>
                        </div>
                        <span class="text-3xl font-bold text-gray-300 mx-2">-</span>
                        <div class="flex flex-col items-center w-5/12">
                            <span class="text-base text-gray-200 font-bold mb-1 truncate">${team2Name}</span>
                            <input type="number" name="sets[${sets.length}][scoreTeam2]" value="" class="w-24 bg-gray-700 border border-gray-600 rounded text-white text-center text-xl py-2" min="0" required>
                        </div>
                    </div>
                `;
                setsContainer.appendChild(tieBreakSetDiv);
            }

            scoreModal.classList.remove('hidden');
        });
    });

    closeScoreModal.addEventListener('click', () => {
        scoreModal.classList.add('hidden');
        scoreMessage.textContent = '';
    });

    scoreForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        scoreMessage.textContent = ''; // Clear previous messages

        const eventId = scoreModalEventId.value;
        const matchId = scoreModalMatchId.value;
        const matchType = scoreModalMatchType.value;
        const poolId = scoreModalPoolId.value;

        const setsData = [];
        setsContainer.querySelectorAll('.flex').forEach((setDiv, index) => {
            const scoreTeam1 = parseInt(setDiv.querySelector(`input[name="sets[${index}][scoreTeam1]"]`).value);
            const scoreTeam2 = parseInt(setDiv.querySelector(`input[name="sets[${index}][scoreTeam2]"]`).value);
            setsData.push({ scoreTeam1, scoreTeam2 });
        });

        try {
            const response = await fetch(`/tournaments/${eventId}/matches/${matchId}/submit-scores`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ sets: setsData, matchType, poolId }),
            });
            const data = await response.json();

            if (data.success) {
                scoreMessage.textContent = data.message;
                scoreMessage.className = 'mt-4 text-center font-semibold text-green-500';
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                scoreMessage.textContent = data.message;
                scoreMessage.className = 'mt-4 text-center font-semibold text-red-500';
            }
        } catch (error) {
            console.error('Erreur lors de la soumission des scores:', error);
            scoreMessage.textContent = 'Une erreur est survenue lors de la soumission des scores.';
            scoreMessage.className = 'mt-4 text-center font-semibold text-red-500';
        }
    });
</script>
